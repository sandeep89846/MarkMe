// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// 1. A BATCH (e.g., "2022IMT", "2022BCS")
model Batch {
  id        String      @id @default(uuid())
  name      String      @unique // "2022IMT"
  students  Student[]
  timetable Timetable[]
}

// 2. A STUDENT (pre-filled by admin)
model Student {
  id        String   @id @default(uuid())
  rollNo    String   @unique
  name      String
  email     String   @unique // This is the link to Google Auth
  googleSub String?  @unique // Null until first login
  batchId   String
  batch     Batch    @relation(fields: [batchId], references: [id])
  devices   Device[]
  attendance AttendanceRecord[]

  @@index([batchId])
}

// 3. A SUBJECT (e.g., "Mobile Computing")
model Subject {
  id        String      @id @default(uuid())
  code      String      @unique // "CS-401"
  name      String
  timetable Timetable[]
  sessions  Session[]
}

// 4. THE TIMETABLE (links Batches to Subjects)
model Timetable {
  id          String  @id @default(uuid())
  batchId     String
  batch       Batch   @relation(fields: [batchId], references: [id])
  subjectId   String
  subject     Subject @relation(fields: [subjectId], references: [id])
  
  dayOfWeek   Int     // 0=Sunday, 1=Monday, ..., 6=Saturday
  startTime   String  // "HH:mm" format, e.g., "09:00"
  endTime     String  // "HH:mm" format, e.g., "10:30"

  // Location is part of the schedule! No more teacher input.
  lat         Float
  lon         Float

  @@index([batchId])
  @@index([subjectId])
}

// 5. A SESSION (a "live" instance of a class)
// This is created by the teacher to "start" the class
model Session {
  id          String    @id @default(uuid())
  subjectId   String
  subject     Subject   @relation(fields: [subjectId], references: [id])
  
  lat         Float     // Copied from Timetable
  lon         Float     // Copied from Timetable
  
  createdAt   DateTime  @default(now())
  expiresAt   DateTime  // Set to Timetable.endTime
  
  nonces    TeacherNonce[]
  attendance AttendanceRecord[]

  @@unique([subjectId, expiresAt])
}

// 6. STUDENT'S DEVICE (links googleSub to a specific phone)
model Device {
  deviceId     String   @id
  studentId    String   // Changed from userId
  student      Student  @relation(fields: [studentId], references: [id])
  pubkeyPem    String
  active       Boolean  @default(true)
  registeredAt DateTime @default(now())

  @@index([studentId])
}

// 7. QR NONCE (generated by teacher's "start class" action)
model TeacherNonce {
  nonce     String   @id
  sessionId String
  session   Session  @relation(fields: [sessionId], references: [id])
  ts        DateTime

  @@index([sessionId])
}

// 8. ATTENDANCE RECORD (the final proof)
model AttendanceRecord {
  id             String   @id // Idempotency key
  sessionId      String
  session        Session  @relation(fields: [sessionId], references: [id])
  studentId      String
  student        Student  @relation(fields: [studentId], references: [id])
  deviceId       String
  
  qrNonce        String
  lat            Float
  lon            Float

  tsClient       DateTime
  serverRecvAt   DateTime @default(now())
  studentSig     String
  attendanceBlob String
  status         String // "VERIFIED", "FAILED_LOCATION", etc.

  @@index([studentId])
  @@index([sessionId])
}